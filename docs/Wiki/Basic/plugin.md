# Docusaurusのプラグイン設定

Docusaurusは様々なプラグインが用意されており、拡張することができます。\
中でも有用なプラグインとその知見についてここで紹介します。

---

### 0. プラグイン設定における注意点

- Docusaurusのバージョンとライブラリのバージョンが一致していないと立ち上げ時にエラーを起こすことがあります。
  - 例えば、現在Docusaurusの最新バージョンはv3.6ですが、`docusaurus-openapi-docs`のバージョンがv4.x.xでなければエラーを起こします。

- プラグイン導入の際は、公式ドキュメントを読みDocusaurusのバージョンにあったプラグインのバージョンをインストールするようにしてください。

- バージョンは指定してインストールするとこれらの問題が解消されます。

package.json 例

```json
  "dependencies": {
    "@docusaurus/core": "3.5.2",
    "@docusaurus/preset-classic": "3.5.2",
    "@docusaurus/theme-classic": "3.5.2",
    "@docusaurus/theme-mermaid": "3.5.2",
    "@mdx-js/react": "^3.0.0",
    "@types/node": "^22.7.3",
    "clsx": "^2.0.0",
    "docusaurus-plugin-openapi-docs": "^4.0.1",
    "docusaurus-theme-openapi-docs": "^4.0.1",
    "prism-react-renderer": "^2.3.0",
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "redocusaurus": "^2.1.1"
  },
```

- 新しいバージョンを追加した際には、`npm start`、`npm build`など基本的な機能がエラーなく起動するか一度確認することをおススメします。

---

### 1. [Mermaid](https://docusaurus.io/docs/api/themes/@docusaurus/theme-mermaid)

- MermaidをMarkdownで利用できるように`@theme/Mermaid`プラグインを導入しています。
- `docusaurus.config.ts`の`themes`に下記設定を追加してください。

```typescript
  // テーマ設定
  themes: ["@docusaurus/theme-mermaid"],

  // markdown設定
  markdown: {
    // Markdownに適用するparserフォーマット（デフォルトでmdx）
    format: "mdx",
    // Mermaid設定（デフォルトでfalse）
    mermaid: true,
    // parse前にMarkdownコンテンツを文字列に変換する（デフォルトでundefined）
    preprocessor: undefined,
    // front matterの拡張（デフォルトでundefined）
    parseFrontMatter: undefined,
    // Docusaurus v3との互換性オプション（既にv3のため使用しない）
    // mdx1Compat: {
    //   comments: true,
    //   admonitions: true,
    //   headingIds: true
    // },
    // Markdownの見出しから生成されるアンカーの動作を制御するオプション
    anchors: {
      maintainCase: true,
    },
    // custonのremark-rehypeを使用する
    // remarkRehypeOptions: undefined
  },
```

---

### 2. [Redocusaurus](https://redocusaurus.vercel.app/docs)

- [Redoc](https://github.com/Redocly/redoc)とは、OpenAPI形式のyamlファイルから、Swaggerより読みやすいAPIドキュメントを生成するOSSのCLIです。
- DocusaurusにRedocを入れるためのプラグインとしてRedocusaurusを使用しています。
- 公式ドキュメント通り`docusaurus.config.ts`の`presets`に以下を導入しています。

```typescript
  presets: [
    ['@docusaurus/preset-classic'],
    // Redocusaurusプラグイン設定
    // https://redocusaurus.vercel.app/docs/getting-started/Installation
    [
      'redocusaurus',
      {
        specs: [
          {
            // open-api.yamlファイルパス
            spec: './docs/open-api.yaml',
            // 出力ディレクトリ
            route: '/api/',
          },
        ],
        theme: {
          primaryColor: '#0209E7',
        },
      },
    ] satisfies Redocusaurus.PresetEntry,
  ],
```

- 本サイトの成果物は[こちら](/api)から確認できます。

---

### 3. [Docusaurus OpenAPI Doc Generator](https://github.com/PaloAltoNetworks/docusaurus-openapi-docs/blob/main/README.md)

- Redocusaurusと同じく、OpenAPI形式のyamlファイルからAPIドキュメントを自動生成する拡張機能です。

- Redocusaurusが全てのAPIを一枚のファイルに出力するのに対して、OpenAPI Doc Generatorでは、個々のAPIファイルを作成します。
  - 本サイトの成果物は[こちら](/docs/Sample/OpenAPI/autoGeneratedFile/add-pet)から確認できます。
  - ※概要、詳細設計の欄以外の部分が自動生成されます。

- `docusaurus.config.ts`の`presets`、`plugins`、`themes`に下記を設定してください。

- `markdownGenerators`を使用すると、生成されるファイルを改修することができます。
  - 詳しくは`insertDetailComponentApiMdGenerator`を確認してください。

```typescript
  presets: [
    [
      "@docusaurus/preset-classic",
      {
        theme: {
          customCss: ["./src/css/custom.css"],
        },
        docs: {
          //サイドバーのパス
          sidebarPath: "./sidebars.ts",
          // ページの左下に「このページを編集」の遷移先URL
          editUrl: "https://github.com/kazuyayagyu/docusaurus_sample/edit/main/",
          // ページ右下に最後に更新した人の名前を表示する
          showLastUpdateAuthor: true,
          // ページ右下に最後に更新された日時を表示する
          showLastUpdateTime: true,
          // docusaurus-theme-openapiの設定用
          docItemComponent: "@theme/ApiItem",
        },
        blog: false,
      },
    ]
  ],

  themes: ["docusaurus-theme-openapi-docs"], // export theme components

  plugins: [
    [
      "docusaurus-plugin-openapi-docs",
      {
        id: "api", // plugin id
        docsPluginId: "classic", // configured for preset-classic
        config: {
          API: {
            // open-api.yamlファイルパス
            specPath: "docs/Sample/open-api.yaml",
            // 出力先
            outputDir: "docs/Sample/OpenAPI/autoGeneratedFile",
            // https://docusaurus-openapi.tryingpan.dev/#markdowngenerators
            markdownGenerators: {
              createApiPageMD: insertDetailComponentApiMdGenerator,
            },
          } satisfies OpenApiPlugin.Options,
        },
      },
    ],
  ],
```

- 上記設定では、`docs/Sample.open-api.yaml`にopen-apiファイルを格納しています。
- 格納後、NPM SCRIPTSの`generate-openapi-doc`コマンドにより、出力先フォルダ`docs/Sample/OpenAPI/autoGeneratedFile`にファイルが自動生成されます。
- NPM SCRIPTSの`clean-openapi-doc`コマンドにより生成したファイルを一括削除することができます。
